# Copyright 2024 Alexandre Mahdhaoui
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
name: shaper
artifactStorePath: .forge/artifact-store.yaml

# ----------------------------------------------------------------------
# -- test defines the test specifications
test:
  # -- verify-tags - verify all test files have build tags
  - name: verify-tags
    runner: "go://go-lint-tags"

  # Linting
  - name: lint
    runner: go://go-lint

  # Unit tests
  - name: unit
    runner: go://go-test

  # Integration tests (requires test environment)
  - name: integration
    testenv: alias://testenv-integration
    runner: go://go-test

  # E2E tests (requires test environment)
  - name: e2e
    testenv: alias://e2e-testenv
    runner: alias://e2e-runner

# ----------------------------------------------------------------------
# -- build defines the artifacts to build
build:
  # OpenAPI generation - shaper v1
  - name: generate-openapi-shaper-v1
    src: .
    engine: go://go-gen-openapi
    spec:
      sourceFile: ./api/shaper.v1.yaml
      destinationDir: ./pkg/generated
      client:
        enabled: true
        packageName: shaperclient
      server:
        enabled: true
        packageName: shaperserver

  # OpenAPI generation - webhook-resolver v1
  - name: generate-openapi-shaper-webhook-resolver-v1
    src: .
    engine: go://go-gen-openapi
    spec:
      sourceFile: ./api/shaper-webhook-resolver.v1.yaml
      destinationDir: ./pkg/generated
      client:
        enabled: true
        packageName: resolverclient
      server:
        enabled: true
        packageName: resolverserver

  # OpenAPI generation - webhook-transformer v1
  - name: generate-openapi-shaper-webhook-transformer-v1
    src: .
    engine: go://go-gen-openapi
    spec:
      sourceFile: ./api/shaper-webhook-transformer.v1.yaml
      destinationDir: ./pkg/generated
      client:
        enabled: true
        packageName: transformerclient
      server:
        enabled: true
        packageName: transformerserver

  # Convenience target to run all code generation in sequence
  - name: generate-all
    src: .
    engine: alias://generate-all

  # Code quality
  - name: format
    src: .
    engine: go://go-format

  # Binaries (require generation to be complete)
  - name: shaper-api
    src: ./cmd/shaper-api
    dest: ./build/bin
    engine: go://go-build

  - name: shaper-controller
    src: ./cmd/shaper-controller
    dest: ./build/bin
    engine: go://go-build

  # Note: The binary needs -tags e2e because it imports pkg/test/e2e which has build tags
  - name: shaper-e2e
    src: ./cmd/shaper-e2e
    dest: ./build/bin
    engine: go://go-build
    spec:
      env:
        CGO_ENABLED: "1"
      args: ["-tags", "e2e"]

  - name: shaper-tftp
    src: ./cmd/shaper-tftp
    dest: ./build/bin
    engine: go://go-build

  - name: shaper-webhook
    src: ./cmd/shaper-webhook
    dest: ./build/bin
    engine: go://go-build

  # E2E testenv subengine binary
  - name: shaper-e2e-testenv
    src: ./cmd/shaper-e2e-testenv
    dest: ./build/bin
    engine: go://go-build
    spec:
      env:
        CGO_ENABLED: "1"
      args: ["-tags", "e2e"]

  # E2E test runner binary
  - name: shaper-e2e-runner
    src: ./cmd/shaper-e2e-runner
    dest: ./build/bin
    engine: go://go-build
    spec:
      env:
        CGO_ENABLED: "1"
      args: ["-tags", "e2e"]

  # Containers (require binaries to be built)
  - name: shaper-api-container
    src: ./containers/shaper-api/Containerfile
    engine: go://container-build

  - name: shaper-controller-container
    src: ./containers/shaper-controller/Containerfile
    engine: go://container-build

  - name: shaper-webhook-container
    src: ./containers/shaper-webhook/Containerfile
    engine: go://container-build

# ----------------------------------------------------------------------
# -- engines defines reusable build engines with custom configurations
engines:
  # Module management
  - alias: go-mod-tidy
    type: builder
    builder:
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["mod", "tidy"]

  - alias: generate-all
    type: builder
    builder:
      # OpenAPI generation - call BuildSpecs
      - engine: go://generic-builder
        spec:
          command: "forge"
          args: ["build", "generate-openapi-shaper-v1"]
      - engine: go://generic-builder
        spec:
          command: "forge"
          args: ["build", "generate-openapi-shaper-webhook-resolver-v1"]
      - engine: go://generic-builder
        spec:
          command: "forge"
          args: ["build", "generate-openapi-shaper-webhook-transformer-v1"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["mod", "tidy"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "object:headerFile=./hack/boilerplate.go.txt", "paths=./cmd/shaper-api/...;./cmd/shaper-controller/...;./cmd/shaper-tftp/...;./cmd/shaper-webhook/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/vmm/...;./pkg/v1alpha1/..."]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "paths=./cmd/shaper-api/...;./cmd/shaper-controller/...;./cmd/shaper-tftp/...;./cmd/shaper-webhook/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/vmm/...;./pkg/v1alpha1/...", "crd:generateEmbeddedObjectMeta=true", "output:crd:artifacts:config=charts/shaper-crds/templates/crds"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "paths=./cmd/shaper-api/...;./cmd/shaper-controller/...;./cmd/shaper-tftp/...;./cmd/shaper-webhook/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/vmm/...;./pkg/v1alpha1/...", "rbac:roleName=shaper", "output:rbac:dir=charts/shaper/templates/rbac"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "paths=./cmd/shaper-api/...;./cmd/shaper-controller/...;./cmd/shaper-tftp/...;./cmd/shaper-webhook/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/vmm/...;./pkg/v1alpha1/...", "rbac:roleName=shaper-webhook", "webhook", "output:rbac:dir=charts/shaper-webhooks/templates", "output:webhook:dir=charts/shaper-webhooks/templates"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["generate", "./..."]
      - engine: go://generic-builder
        spec:
          command: "rm"
          args: ["-rf", "./internal/util/mocks"]
      - engine: go://go-gen-mocks

  - alias: testenv-integration
    type: testenv
    testenv:
      - engine: go://testenv-kind
      - engine: go://testenv-lcr
        spec:
          enabled: true
          namespace: testenv-lcr
          imagePullSecretName: testenv-lcr-credentials
          imagePullSecretNamespaces:
            - default
            - shaper-system
          images:
            - name: local://shaper-controller-container:latest
            - name: local://shaper-webhook-container:latest
      - engine: go://testenv-helm-install
        spec:
          charts:
            - name: shaper-crds
              sourceType: local
              path: ./charts/shaper-crds
              namespace: default
              releaseName: shaper-crds
              createNamespace: false
              timeout: "5m"

            - name: shaper-controller
              sourceType: local
              path: ./charts/shaper-controller
              namespace: shaper-system
              releaseName: shaper-controller
              createNamespace: true
              timeout: "5m"
              values:
                image:
                  repository: testenv-lcr.testenv-lcr.svc.cluster.local:5000/shaper-controller-container
                  tag: latest
                  pullPolicy: IfNotPresent
                imagePullSecrets:
                  - name: testenv-lcr-credentials

            - name: shaper-webhooks
              sourceType: local
              path: ./charts/shaper-webhooks
              namespace: shaper-system
              releaseName: shaper-webhooks
              createNamespace: false
              timeout: "5m"
              values:
                image:
                  repository: testenv-lcr.testenv-lcr.svc.cluster.local:5000/shaper-webhook-container
                  tag: latest
                  pullPolicy: IfNotPresent
                imagePullSecrets:
                  - name: testenv-lcr-credentials

  - alias: e2e-test
    type: test-runner
    testRunner:
      - engine: go://generic-test-runner
        spec:
          command: "./test/e2e/main.sh"
          args: ["full-test"]
          env:
            CGO_ENABLED: "1"

  # E2E test environment (orchestrates setup)
  - alias: e2e-testenv
    type: testenv
    testenv:
      - engine: go://testenv-kind
      - engine: go://testenv-lcr
        spec:
          enabled: true
          namespace: testenv-lcr
          imagePullSecretName: testenv-lcr-credentials
          imagePullSecretNamespaces:
            - default
            - shaper-system
          images:
            - name: local://shaper-api-container:latest
            - name: local://shaper-controller-container:latest
            - name: local://shaper-webhook-container:latest
      - engine: go://testenv
        subengines:
          - name: shaper-e2e-testenv
            create:
              command: ./build/bin/shaper-e2e-testenv
              args: ["create"]
            delete:
              command: ./build/bin/shaper-e2e-testenv
              args: ["delete", "{{.ID}}"]

  # E2E test runner (executes scenarios)
  - alias: e2e-runner
    type: test-runner
    testRunner:
      - engine: go://generic-test-runner
        spec:
          command: "./test/e2e/main.sh"
          args: ["run-scenario"]
          env:
            CGO_ENABLED: "1"

