# Copyright 2024 Alexandre Mahdhaoui
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
name: shaper
artifactStorePath: .forge/artifact-store.yaml
envFile: .envrc

# ----------------------------------------------------------------------
# -- test defines the test specifications
test:
  # -- verify-tags - verify all test files have build tags
  - name: lint-tags
    runner: "go://go-lint-tags"

  - name: lint-licenses
    runner: "go://go-lint-licenses"

  # Linting
  - name: lint
    runner: go://go-lint

  # Unit tests
  - name: unit
    runner: go://go-test

  # E2E tests (requires test environment)
  - name: e2e
    testenv: alias://e2e-testenv
    runner: go://go-test
    spec:
      timeout: "20m"

# ----------------------------------------------------------------------
# -- build defines the artifacts to build
build:
  # OpenAPI generation - shaper v1
  - name: generate-openapi-shaper-v1
    src: .
    engine: alias://go-gen-openapi-with-license
    spec:
      sourceFile: ./api/shaper.v1.yaml
      destinationDir: ./pkg/generated
      client:
        enabled: true
        packageName: shaperclient
      server:
        enabled: true
        packageName: shaperserver

  # OpenAPI generation - webhook-resolver v1
  - name: generate-openapi-shaper-webhook-resolver-v1
    src: .
    engine: alias://go-gen-openapi-with-license
    spec:
      sourceFile: ./api/shaper-webhook-resolver.v1.yaml
      destinationDir: ./pkg/generated
      client:
        enabled: true
        packageName: resolverclient
      server:
        enabled: true
        packageName: resolverserver

  # OpenAPI generation - webhook-transformer v1
  - name: generate-openapi-shaper-webhook-transformer-v1
    src: .
    engine: alias://go-gen-openapi-with-license
    spec:
      sourceFile: ./api/shaper-webhook-transformer.v1.yaml
      destinationDir: ./pkg/generated
      client:
        enabled: true
        packageName: transformerclient
      server:
        enabled: true
        packageName: transformerserver

  # Convenience target to run all code generation in sequence
  - name: generate-all
    src: .
    engine: alias://generate-all

  # Code quality
  - name: format
    src: .
    engine: go://go-format

  # Binaries (require generation to be complete)
  - name: shaper-api
    src: ./cmd/shaper-api
    dest: ./build/bin
    engine: go://go-build

  - name: shaper-controller
    src: ./cmd/shaper-controller
    dest: ./build/bin
    engine: go://go-build

  - name: shaper-tftp
    src: ./cmd/shaper-tftp
    dest: ./build/bin
    engine: go://go-build

  - name: shaper-webhook
    src: ./cmd/shaper-webhook
    dest: ./build/bin
    engine: go://go-build

  # Containers (require binaries to be built)
  - name: shaper-api
    src: ./containers/shaper-api/Containerfile
    engine: go://container-build
    spec:
      dependsOn:
        - engine: go://go-dependency-detector
          spec:
            filepath: ./cmd/shaper-api/main.go
            funcName: main

  - name: shaper-controller
    src: ./containers/shaper-controller/Containerfile
    engine: go://container-build
    spec:
      dependsOn:
        - engine: go://go-dependency-detector
          spec:
            filepath: ./cmd/shaper-controller/main.go
            funcName: main

  - name: shaper-webhook
    src: ./containers/shaper-webhook/Containerfile
    engine: go://container-build
    spec:
      dependsOn:
        - engine: go://go-dependency-detector
          spec:
            filepath: ./cmd/shaper-webhook/main.go
            funcName: main

# ----------------------------------------------------------------------
# -- engines defines reusable build engines with custom configurations
engines:
  # OpenAPI generation with license headers
  - alias: go-gen-openapi-with-license
    type: builder
    builder:
      - engine: go://go-gen-openapi
      - engine: go://generic-builder
        spec:
          command: "bash"
          args: ["./hack/add-license-headers.sh"]

  # Module management
  - alias: go-mod-tidy
    type: builder
    builder:
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["mod", "tidy"]

  - alias: generate-all
    type: builder
    builder:
      # OpenAPI generation - call BuildSpecs
      - engine: go://generic-builder
        spec:
          command: "forge"
          args: ["build", "generate-openapi-shaper-v1"]
      - engine: go://generic-builder
        spec:
          command: "forge"
          args: ["build", "generate-openapi-shaper-webhook-resolver-v1"]
      - engine: go://generic-builder
        spec:
          command: "forge"
          args: ["build", "generate-openapi-shaper-webhook-transformer-v1"]
      # Add license headers to oapi-codegen generated files
      - engine: go://generic-builder
        spec:
          command: "bash"
          args: ["./hack/add-license-headers.sh"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["mod", "tidy"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "object:headerFile=./hack/boilerplate.go.txt", "paths=./cmd/shaper-api/...;./cmd/shaper-controller/...;./cmd/shaper-tftp/...;./cmd/shaper-webhook/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/v1alpha1/..."]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "paths=./cmd/shaper-api/...;./cmd/shaper-controller/...;./cmd/shaper-tftp/...;./cmd/shaper-webhook/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/v1alpha1/...", "crd:generateEmbeddedObjectMeta=true", "output:crd:artifacts:config=charts/shaper-crds/templates/crds"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "paths=./cmd/shaper-api/...;./cmd/shaper-controller/...;./cmd/shaper-tftp/...;./cmd/shaper-webhook/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/v1alpha1/...", "rbac:roleName=shaper", "output:rbac:dir=charts/shaper/templates/rbac"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "paths=./cmd/shaper-api/...;./cmd/shaper-controller/...;./cmd/shaper-tftp/...;./cmd/shaper-webhook/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/v1alpha1/...", "rbac:roleName=shaper-webhook", "webhook", "output:rbac:dir=charts/shaper-webhooks/templates", "output:webhook:dir=charts/shaper-webhooks/templates"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["generate", "./..."]
      - engine: go://generic-builder
        spec:
          command: "rm"
          args: ["-rf", "./internal/util/mocks"]
      - engine: go://go-gen-mocks

  - alias: e2e-test
    type: test-runner
    testRunner:
      - engine: go://generic-test-runner
        spec:
          command: "./test/e2e/main.sh"
          args: ["full-test"]
          env:
            CGO_ENABLED: "1"

  # E2E test environment (shared with integration tests)
  - alias: e2e-testenv
    type: testenv
    testenv:
      - engine: go://testenv-kind
      - engine: go://testenv-lcr
        spec:
          enabled: true
          namespace: testenv-lcr
          imagePullSecretName: testenv-lcr-credentials
          imagePullSecretNamespaces:
            - default
            - shaper-system
          images:
            - name: local://shaper-api:latest
            - name: local://shaper-controller:latest
            - name: local://shaper-webhook:latest
      - engine: go://testenv-helm-install
        spec:
          charts:
            - name: shaper-crds
              sourceType: local
              path: ./charts/shaper-crds
              namespace: default
              releaseName: shaper-crds
              createNamespace: false
              timeout: "5m"

            - name: shaper-controller
              sourceType: local
              path: ./charts/shaper-controller
              namespace: shaper-system
              releaseName: shaper-controller
              createNamespace: true
              timeout: "5m"
              values:
                image:
                  repository: "{{.Env.TESTENV_LCR_FQDN}}/shaper-controller"
                  tag: latest
                  pullPolicy: IfNotPresent
                imagePullSecrets:
                  - name: testenv-lcr-credentials

            - name: shaper-webhooks
              sourceType: local
              path: ./charts/shaper-webhooks
              namespace: shaper-system
              releaseName: shaper-webhooks
              createNamespace: false
              timeout: "5m"
              values:
                image:
                  repository: "{{.Env.TESTENV_LCR_FQDN}}/shaper-webhook"
                  tag: latest
                  pullPolicy: IfNotPresent
                imagePullSecrets:
                  - name: testenv-lcr-credentials

            - name: shaper-api
              sourceType: local
              path: ./charts/shaper-api
              namespace: shaper-system
              releaseName: shaper-api
              createNamespace: false
              timeout: "5m"
              values:
                config:
                  assignmentNamespace: shaper-system
                  profileNamespace: shaper-system
                image:
                  repository: "{{.Env.TESTENV_LCR_FQDN}}/shaper-api"
                  tag: latest
                  pullPolicy: IfNotPresent
                imagePullSecrets:
                  - name: testenv-lcr-credentials
                service:
                  type: NodePort
                  nodePort: '{{ allocateOpenPort "0.0.0.0" "shaper-e2e-api" 30000 32767 }}'
                # Pre-allocate mTLS NodePort for e2e tests (value unused by chart, but
                # the allocateOpenPort call registers it as PORTALLOC_SHAPER_E2E_MTLS).
                mtlsNodePort: '{{ allocateOpenPort "0.0.0.0" "shaper-e2e-mtls" 30000 32767 }}'
      # VM infrastructure for E2E testing
      - engine: go://github.com/alexandremahdhaoui/testenv-vm/cmd/testenv-vm@v0.12.1
        deferTemplates: true
        spec:
          # Use /tmp for state directory so libvirt can access disk images
          stateDir: /tmp/shaper-testenv-vm
          images:
            - name: dnsmasq-base
              spec:
                source: ubuntu:24.04
                customize:
                  packages:
                    - dnsmasq
                    - curl
                    - git
                    - make
                    - gcc
                    - binutils
                    - perl
                    - liblzma-dev
                  runcmd:
                    - "git clone https://github.com/ipxe/ipxe.git /opt/ipxe"
                    - "cd /opt/ipxe && git checkout fa62213231a882eb6bbcefa7ad1106bdb9aaeae2"
                    - |
                      cat > /opt/ipxe/src/embed.ipxe << 'IPXE_EOF'
                      #!ipxe
                      dhcp
                      :retry
                      chain tftp://${next-server}/boot.ipxe || sleep 1 || goto retry
                      IPXE_EOF
                    - "cd /opt/ipxe/src && make bin/undionly.kpxe EMBED=embed.ipxe NO_WERROR=1"
                    - "mkdir -p /var/lib/tftpboot"
                    - "cp /opt/ipxe/src/bin/undionly.kpxe /var/lib/tftpboot/undionly.kpxe"
                    - "apt-get clean && rm -rf /var/lib/apt/lists/*"
          providers:
            - name: libvirt
              engine: go://github.com/alexandremahdhaoui/testenv-vm/cmd/providers/testenv-vm-provider-libvirt@v0.12.1
              default: true
              spec: {}

          keys:
            - name: VmSsh
              provider: libvirt
              spec:
                type: ed25519

          networks:
            - name: TestNetwork
              kind: nat
              provider: libvirt
              spec:
                cidr: "192.168.100.0/24"
                # Disable libvirt's built-in DHCP so dnsmasq can provide DHCP with PXE options
                dhcp:
                  enabled: false

          vms:
            - name: DnsmasqServer
              provider: libvirt
              spec:
                memory: 1024
                vcpus: 1
                network: TestNetwork
                disk:
                  baseImage: "{{ .Images.dnsmasq-base.Path }}"
                  size: 5G
                cloudInit:
                  hostname: dnsmasq-server
                  # Static network config - applied before any cloud-init modules run
                  networkConfig:
                    ethernets:
                      - name: ens2
                        addresses:
                          - "192.168.100.2/24"
                        gateway4: "192.168.100.1"
                        nameservers:
                          addresses:
                            - "8.8.8.8"
                  writeFiles:
                    # Write dnsmasq config to /tmp first; cloud-init's write_files
                    # runs BEFORE packages, so apt install dnsmasq would overwrite
                    # /etc/dnsmasq.conf with the package default. We copy it in
                    # runcmd (which runs AFTER packages) before restarting dnsmasq.
                    - path: /tmp/dnsmasq.conf
                      content: |
                        interface=ens2
                        bind-interfaces
                        dhcp-range=192.168.100.50,192.168.100.200,12h
                        dhcp-authoritative
                        dhcp-option=3,192.168.100.1
                        server=8.8.8.8
                        server=8.8.4.4
                        address=/shaper.local/192.168.100.1
                        address=/shaper-api.local/192.168.100.1
                        enable-tftp
                        tftp-root=/var/lib/tftpboot
                        # Always serve the custom iPXE binary via TFTP to ALL PXE clients.
                        # QEMU's built-in iPXE ROM (v1.21.1) does NOT resolve ${uuid} from
                        # SMBIOS tables, so we must chainload our custom-compiled iPXE which
                        # does resolve ${uuid} correctly. The embedded script in undionly.kpxe
                        # calls 'dhcp' (not 'autoboot'), so it configures networking without
                        # re-triggering TFTP boot â€” no infinite chainloading loop.
                        dhcp-boot=undionly.kpxe,,192.168.100.2
                        log-dhcp
                      permissions: "0644"
                    - path: /var/lib/tftpboot/boot.ipxe
                      content: |
                        #!ipxe
                        :retry
                        chain http://shaper.local:{{ .Env.PORTALLOC_SHAPER_E2E_API }}/ipxe?uuid=${uuid}&buildarch=${buildarch:uristring} || sleep 1 || goto retry
                      permissions: "0644"
                  runcmd:
                    - "systemctl disable --now systemd-resolved"
                    - "rm -f /etc/resolv.conf"
                    - "echo 'nameserver 8.8.8.8' > /etc/resolv.conf"
                    - "cp /tmp/dnsmasq.conf /etc/dnsmasq.conf"
                    - "systemctl restart dnsmasq"
                    - "sysctl -w net.ipv4.ip_forward=1"
                    - "iptables -t nat -A POSTROUTING -s 192.168.100.0/24 ! -d 192.168.100.0/24 -j MASQUERADE"
                  users:
                    - name: ubuntu
                      sudo: "ALL=(ALL) NOPASSWD:ALL"
                      sshAuthorizedKeys:
                        - "{{ .Keys.VmSsh.PublicKey }}"
                boot:
                  order: [hd]
                  firmware: bios
                readiness:
                  ssh:
                    enabled: true
                    timeout: "5m"
                    user: ubuntu
                    privateKey: "{{ .Keys.VmSsh.PrivateKeyPath }}"
                  cloudInit:
                    enabled: true
                    timeout: "10m"

            - name: PxeClient
              provider: libvirt
              spec:
                memory: 2048
                vcpus: 2
                network: TestNetwork
                disk:
                  size: 1G
                boot:
                  order: [network]
                  firmware: bios
                readiness:
                  ssh:
                    enabled: false
