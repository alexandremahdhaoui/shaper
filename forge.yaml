# Copyright 2024 Alexandre Mahdhaoui
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
name: shaper
artifactStorePath: .forge/artifact-store.yaml

# ----------------------------------------------------------------------
# -- test defines the test specifications
test:
  # -- verify-tags - verify all test files have build tags
  - name: verify-tags
    runner: "go://test-runner-go-verify-tags"

  # Linting
  - name: lint
    runner: go://lint-go

  # Unit tests
  - name: unit
    runner: go://test-runner-go

  # Integration tests (requires test environment)
  - name: integration
    testenv: alias://testenv-integration
    runner: go://test-runner-go

  # E2E tests (requires test environment)
  - name: e2e
    testenv: go://kindenv
    runner: alias://e2e-test

# ----------------------------------------------------------------------
generateOpenAPI:
  defaults:
    # -- sourceDir is the default directory locating the open api specifications.
    sourceDir: ./api
    # -- destinationDir is the default local directory where the generated packages will be written to.
    destinationDir: ./pkg/generated
    # -- engine that will generate the openapi configuration
    engine: go://generate-openapi-go

  specs:
    # shaper
    - name: shaper
      versions:
        - v1
      client:
        enabled: true
        packageName: shaperclient
      server:
        enabled: true
        packageName: shaperserver

    # webhook-resolver
    - name: shaper-webhook-resolver
      versions:
        - v1
      client:
        enabled: true
        packageName: resolverclient
      server:
        enabled: true
        packageName: resolverserver

    # webhook-transformer
    - name: shaper-webhook-transformer
      versions:
        - v1
      client:
        enabled: true
        packageName: transformerclient
      server:
        enabled: true
        packageName: transformerserver

# ----------------------------------------------------------------------
# -- build defines the artifacts to build
build:
  # Convenience target to run all code generation in sequence
  - name: generate-all
    src: .
    engine: alias://generate-all

  # Code quality
  - name: format
    src: .
    engine: go://format-go

  # Binaries (require generation to be complete)
  - name: shaper-api-binary
    src: ./cmd/shaper-api
    dest: ./build/bin
    engine: go://build-go
    config:
      outputName: shaper-api
      ldflags: "-X main.BuildTimestamp={{.Timestamp}} -X main.CommitSHA={{.CommitSHA}} -X main.Version={{.Version}}"
      env:
        CGO_ENABLED: "0"

  - name: shaper-controller-binary
    src: ./cmd/shaper-controller
    dest: ./build/bin
    engine: go://build-go
    config:
      outputName: shaper-controller
      ldflags: "-X main.BuildTimestamp={{.Timestamp}} -X main.CommitSHA={{.CommitSHA}} -X main.Version={{.Version}}"
      env:
        CGO_ENABLED: "0"

  # Note: shaper-e2e requires CGO and libvirt-dev to build
  # If forge build fails, use: CGO_ENABLED=1 go build -o build/bin/shaper-e2e ./cmd/shaper-e2e
  - name: shaper-e2e-binary
    src: ./cmd/shaper-e2e
    dest: ./build/bin
    engine: go://build-go
    config:
      outputName: shaper-e2e
      ldflags: "-X main.BuildTimestamp={{.Timestamp}} -X main.CommitSHA={{.CommitSHA}} -X main.Version={{.Version}}"
      env:
        CGO_ENABLED: "1"

  - name: shaper-tftp-binary
    src: ./cmd/shaper-tftp
    dest: ./build/bin
    engine: go://build-go
    config:
      outputName: shaper-tftp
      ldflags: "-X main.BuildTimestamp={{.Timestamp}} -X main.CommitSHA={{.CommitSHA}} -X main.Version={{.Version}}"
      env:
        CGO_ENABLED: "0"

  - name: shaper-webhook-binary
    src: ./cmd/shaper-webhook
    dest: ./build/bin
    engine: go://build-go
    config:
      outputName: shaper-webhook
      ldflags: "-X main.BuildTimestamp={{.Timestamp}} -X main.CommitSHA={{.CommitSHA}} -X main.Version={{.Version}}"
      env:
        CGO_ENABLED: "0"

  # Containers (require binaries to be built)
  - name: shaper-api-container
    src: ./containers/shaper-api/Containerfile
    engine: go://build-container
    config:
      tags: ["shaper-api:latest"]

  - name: shaper-webhook-container
    src: ./containers/shaper-webhook/Containerfile
    engine: go://build-container
    config:
      tags: ["shaper-webhook:latest"]

# ----------------------------------------------------------------------
# -- engines defines reusable build engines with custom configurations
engines:
  # Module management
  - alias: go-mod-tidy
    type: builder
    builder:
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["mod", "tidy"]

  - alias: generate-all
    type: builder
    builder:
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["mod", "tidy"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "object:headerFile=./hack/boilerplate.go.txt", "paths=./cmd/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/v1alpha1/..."]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "paths=./cmd/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/v1alpha1/...", "crd:generateEmbeddedObjectMeta=true", "output:crd:artifacts:config=charts/shaper-crds/templates/crds"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "paths=./cmd/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/v1alpha1/...", "rbac:roleName=shaper", "output:rbac:dir=charts/shaper/templates/rbac"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["run", "sigs.k8s.io/controller-tools/cmd/controller-gen@v0.19.0", "paths=./cmd/...;./internal/...;./pkg/cloudinit/...;./pkg/constants/...;./pkg/execcontext/...;./pkg/generated/...;./pkg/network/...;./pkg/v1alpha1/...", "rbac:roleName=shaper-webhook", "webhook", "output:rbac:dir=charts/shaper-webhooks/templates", "output:webhook:dir=charts/shaper-webhooks/templates"]
      - engine: go://generic-builder
        spec:
          command: "go"
          args: ["generate", "./..."]
      - engine: go://generic-builder
        spec:
          command: "rm"
          args: ["-rf", "./internal/util/mocks"]
      - engine: go://generate-mocks

  - alias: testenv-integration
    type: testenv
    testenv:
      - engine: go://testenv-kind
      - engine: go://testenv-lcr
        spec:
          # -- autoPushImages defines whether to automatically push images from artifact store on setup.
          autoPushImages: true
          # -- enabled defines whether the local container registry must be created or not.
          enabled: true
      - engine: go://testenv-helm-install
        spec:
          charts: []

  - alias: e2e-test
    type: test-runner
    testRunner:
      - engine: go://generic-test-runner
        spec:
          command: "./test/e2e/main.sh"
          args: ["full-test"]

