name: "Multi-VM Test with Different Profiles"
description: |
  Validates parallel provisioning of multiple VMs with different configurations.
  VM1: Worker role with custom profile
  VM2: Control plane role with different profile
  Tests that each VM gets correct Assignment and Profile.

tags: ["multi-vm", "parallel", "roles"]

architecture: "x86_64"

# VMs: Two VMs with different roles
vms:
  # Worker VM
  - name: "test-vm-worker"
    uuid: "11111111-1111-1111-1111-111111111111"
    macAddress: "52:54:00:11:11:11"
    memory: "2048"  # 2GB RAM
    vcpus: 2
    bootOrder: ["network"]
    labels:
      role: "worker"
      env: "test"

  # Control plane VM
  - name: "test-vm-control"
    uuid: "22222222-2222-2222-2222-222222222222"
    macAddress: "52:54:00:22:22:22"
    memory: "4096"  # 4GB RAM
    vcpus: 4
    bootOrder: ["network"]
    labels:
      role: "control-plane"
      env: "test"

# Resources: Profiles and Assignments for each role
resources:
  # Worker Profile
  - kind: "Profile"
    name: "worker-profile"
    namespace: "shaper-system"
    yaml: |
      apiVersion: shaper.amahdha.com/v1alpha1
      kind: Profile
      metadata:
        name: worker-profile
        namespace: shaper-system
        labels:
          profile: "worker"
          role: "worker"
      spec:
        ipxe: |
          #!ipxe
          echo ====================================
          echo  Worker Node Profile
          echo ====================================
          echo Role: Worker
          echo UUID: ${uuid}
          echo MAC: ${mac}
          echo
          echo Initializing worker node...
          shell

  # Control Plane Profile
  - kind: "Profile"
    name: "control-plane-profile"
    namespace: "shaper-system"
    yaml: |
      apiVersion: shaper.amahdha.com/v1alpha1
      kind: Profile
      metadata:
        name: control-plane-profile
        namespace: shaper-system
        labels:
          profile: "control-plane"
          role: "control-plane"
      spec:
        ipxe: |
          #!ipxe
          echo ====================================
          echo  Control Plane Profile
          echo ====================================
          echo Role: Control Plane
          echo UUID: ${uuid}
          echo MAC: ${mac}
          echo
          echo Initializing control plane node...
          shell

  # Worker Assignment
  - kind: "Assignment"
    name: "worker-assignment"
    namespace: "shaper-system"
    yaml: |
      apiVersion: shaper.amahdha.com/v1alpha1
      kind: Assignment
      metadata:
        name: worker-assignment
        namespace: shaper-system
      spec:
        subjectSelectors:
          matchLabels:
            uuid: "11111111-1111-1111-1111-111111111111"
        profileSelectors:
          matchLabels:
            profile: "worker"
        buildArch: "x86_64"

  # Control Plane Assignment
  - kind: "Assignment"
    name: "control-plane-assignment"
    namespace: "shaper-system"
    yaml: |
      apiVersion: shaper.amahdha.com/v1alpha1
      kind: Assignment
      metadata:
        name: control-plane-assignment
        namespace: shaper-system
      spec:
        subjectSelectors:
          matchLabels:
            uuid: "22222222-2222-2222-2222-222222222222"
        profileSelectors:
          matchLabels:
            profile: "control-plane"
        buildArch: "x86_64"

# Assertions: Validate both VMs independently
assertions:
  # Worker VM assertions
  - type: "dhcp_lease"
    vm: "test-vm-worker"
    description: "Worker VM should obtain DHCP lease"

  - type: "http_boot_called"
    vm: "test-vm-worker"
    description: "Worker VM should call shaper-API"

  - type: "assignment_match"
    vm: "test-vm-worker"
    expected: "worker-assignment"
    description: "Worker VM should match worker assignment"

  - type: "profile_match"
    vm: "test-vm-worker"
    expected: "worker-profile"
    description: "Worker VM should receive worker profile"

  # Control Plane VM assertions
  - type: "dhcp_lease"
    vm: "test-vm-control"
    description: "Control plane VM should obtain DHCP lease"

  - type: "http_boot_called"
    vm: "test-vm-control"
    description: "Control plane VM should call shaper-API"

  - type: "assignment_match"
    vm: "test-vm-control"
    expected: "control-plane-assignment"
    description: "Control plane VM should match control plane assignment"

  - type: "profile_match"
    vm: "test-vm-control"
    expected: "control-plane-profile"
    description: "Control plane VM should receive control plane profile"

timeouts:
  dhcpLease: "30s"
  tftpBoot: "60s"
  httpBoot: "120s"
  vmProvision: "180s"
  resourceReady: "60s"
  assertionPoll: "2s"

expectedOutcome:
  status: "passed"
  description: |
    Both VMs boot successfully in parallel.
    Worker VM gets worker profile.
    Control plane VM gets control plane profile.
    No configuration cross-contamination.
