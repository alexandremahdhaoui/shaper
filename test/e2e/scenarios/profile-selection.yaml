name: "Profile Selection by Label Selector Test"
description: |
  Validates that Assignments correctly select Profiles based on label selectors.
  Creates multiple Profiles with different labels and an Assignment that selects
  the correct Profile using labelSelector matching.
  Demonstrates Profile selection flexibility.

tags: ["profile", "selectors", "labels"]

architecture: "x86_64"

# VMs: Single VM that will use Profile selected via labels
vms:
  - name: "test-vm-profile-selection"
    uuid: "33333333-3333-3333-3333-333333333333"
    macAddress: "52:54:00:33:33:33"
    memory: "1024"
    vcpus: 1
    bootOrder: ["network"]

# Resources: Multiple Profiles with different labels, Assignment selects one
resources:
  # Profile 1: Development environment (NOT selected)
  - kind: "Profile"
    name: "dev-profile"
    namespace: "shaper-system"
    yaml: |
      apiVersion: shaper.amahdha.com/v1alpha1
      kind: Profile
      metadata:
        name: dev-profile
        namespace: shaper-system
        labels:
          profile: "dev"
          environment: "development"
          tier: "testing"
      spec:
        ipxe: |
          #!ipxe
          echo ====================================
          echo  Development Profile (NOT EXPECTED)
          echo ====================================
          echo This profile should NOT be selected
          shell

  # Profile 2: Production environment (SELECTED by Assignment)
  - kind: "Profile"
    name: "prod-profile"
    namespace: "shaper-system"
    yaml: |
      apiVersion: shaper.amahdha.com/v1alpha1
      kind: Profile
      metadata:
        name: prod-profile
        namespace: shaper-system
        labels:
          profile: "prod"
          environment: "production"
          tier: "critical"
      spec:
        ipxe: |
          #!ipxe
          echo ====================================
          echo  Production Profile (EXPECTED)
          echo ====================================
          echo This profile SHOULD be selected
          echo Environment: Production
          echo Tier: Critical
          echo UUID: ${uuid}
          echo
          echo Profile selection by labels: SUCCESS
          shell

  # Profile 3: Staging environment (NOT selected)
  - kind: "Profile"
    name: "staging-profile"
    namespace: "shaper-system"
    yaml: |
      apiVersion: shaper.amahdha.com/v1alpha1
      kind: Profile
      metadata:
        name: staging-profile
        namespace: shaper-system
        labels:
          profile: "staging"
          environment: "staging"
          tier: "testing"
      spec:
        ipxe: |
          #!ipxe
          echo ====================================
          echo  Staging Profile (NOT EXPECTED)
          echo ====================================
          echo This profile should NOT be selected
          shell

  # Assignment: Selects production Profile using label selector
  - kind: "Assignment"
    name: "prod-assignment"
    namespace: "shaper-system"
    yaml: |
      apiVersion: shaper.amahdha.com/v1alpha1
      kind: Assignment
      metadata:
        name: prod-assignment
        namespace: shaper-system
      spec:
        subjectSelectors:
          matchLabels:
            uuid: "33333333-3333-3333-3333-333333333333"
        # CRITICAL: This selector should match ONLY prod-profile
        profileSelectors:
          matchLabels:
            environment: "production"
            tier: "critical"
        buildArch: "x86_64"

# Assertions: Validate Profile selection logic
assertions:
  - type: "dhcp_lease"
    vm: "test-vm-profile-selection"
    description: "VM should obtain DHCP lease"

  - type: "http_boot_called"
    vm: "test-vm-profile-selection"
    description: "VM should call shaper-API"

  - type: "assignment_match"
    vm: "test-vm-profile-selection"
    expected: "prod-assignment"
    description: "Production Assignment should be matched"

  # CRITICAL: Verify correct Profile was selected based on labels
  - type: "profile_match"
    vm: "test-vm-profile-selection"
    expected: "prod-profile"
    description: "Production Profile should be selected (not dev or staging)"

timeouts:
  dhcpLease: "30s"
  tftpBoot: "60s"
  httpBoot: "120s"
  vmProvision: "180s"
  resourceReady: "60s"
  assertionPoll: "2s"

expectedOutcome:
  status: "passed"
  description: |
    VM matches Assignment, Assignment selects prod-profile based on labels.
    Demonstrates Profile selection via label selectors works correctly.
    Other Profiles (dev, staging) should NOT be selected.
